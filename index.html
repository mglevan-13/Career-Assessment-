<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Career Fit Assessment</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e9efff}
    header{padding:16px;border-bottom:1px solid rgba(255,255,255,.12);position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(10px)}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}
    .muted{color:rgba(233,239,255,.70);font-size:13px;line-height:1.45}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#e9efff;padding:12px 14px;font-weight:800}
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn.primary{background:linear-gradient(135deg,#2f6bff,#1f4ed0);border-color:rgba(47,107,255,.8)}
    .opt{width:100%;text-align:left}
    .barWrap{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#2f6bff,#7fb1ff);transition:width .2s}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12.5px;color:rgba(233,239,255,.72)}
    .pill b{color:#e9efff}
    input,select{width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:#e9efff;outline:none}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:950;font-size:18px">Career Fit Assessment</div>
        <div class="muted"><b>“Come, follow me,” Jesus said.</b> — Matthew 4:19 (NIV)</div>
        <div class="muted" id="status">Loading…</div>
      </div>
      <div class="row">
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn" id="printBtn">Print</button>
      </div>
    </div>
    <div class="barWrap" style="margin-top:10px"><div class="bar" id="bar"></div></div>
  </div>
</header>

<main class="wrap">
  <div class="card" id="app"></div>
</main>

<script>
const MAX_Q = 20;            // keep teen-friendly; expand later
const SHOW_TOP = 15;         // show top careers
const DIMS = ["R","I","A","S","E","C","people","systems","creative","handsOn","structure","autonomy","outdoors","travel","focusDesk","stressTol","service","persuasion","detail","leadership","eduTolerance","debtAversion"];

let QUESTIONS=null, CAREERS=null;

let state = {
  answered: 0,
  askedIds: [],
  scores: {},
  finished: false
};

function initScores(){
  state.scores = {};
  for (const d of DIMS) state.scores[d]=0;
}
initScores();

const elApp = document.getElementById("app");
const elStatus = document.getElementById("status");
const elBar = document.getElementById("bar");

document.getElementById("resetBtn").onclick = () => { resetAll(); };
document.getElementById("printBtn").onclick = () => window.print();

function setStatus(msg){ elStatus.textContent = msg; }
function setBar(){ elBar.style.width = (state.answered / MAX_Q * 100) + "%"; }

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s])); }

async function loadData(){
  try{
    const [q, c] = await Promise.all([
      fetch("./questions.json", {cache:"no-store"}).then(r=>r.json()),
      fetch("./careers.json", {cache:"no-store"}).then(r=>r.json())
    ]);
    QUESTIONS = q.questions;
    CAREERS = c.careers;

    setStatus(`Loaded ${QUESTIONS.length} questions and ${CAREERS.length} careers.`);
    renderQuestion();
  }catch(e){
    setStatus("Could not load questions.json or careers.json.");
    elApp.innerHTML = `
      <div style="font-weight:950;font-size:18px;margin-bottom:6px">Setup error</div>
      <div class="muted">Your site can’t load <b>questions.json</b> and/or <b>careers.json</b> from the same folder as <b>index.html</b>.</div>
      <div class="muted" style="margin-top:10px">Fix: confirm all three files are in the repo root and spelled exactly:
        <div class="pill"><b>index.html</b></div>
        <div class="pill"><b>questions.json</b></div>
        <div class="pill"><b>careers.json</b></div>
      </div>
      <div class="muted" style="margin-top:10px">Also: JSON cannot contain comments like <code>//</code> or <code>/* */</code>.</div>
    `;
  }
}

function pickNextQuestion(){
  const asked = new Set(state.askedIds);
  const pool = QUESTIONS.filter(q => !asked.has(q.id));
  if (!pool.length) return null;

  // simple “adaptive” selection: prioritize questions that touch least-measured dims
  const uncertainty = {};
  for (const d of DIMS) uncertainty[d] = 1 / (1 + Math.abs(state.scores[d]));

  let best=null, bestScore=-Infinity;
  for (const q of pool){
    let s=0;
    for (const [dim,w] of Object.entries(q.weights)){
      s += (uncertainty[dim] || 0.2) * Math.abs(w);
    }
    s += Math.random()*0.05;
    if (s>bestScore){ bestScore=s; best=q; }
  }
  return best;
}

function applyAnswer(q, value){
  // value 1..5 => centered -2..+2
  const centered = value - 3;
  for (const [dim,w] of Object.entries(q.weights)){
    state.scores[dim] = (state.scores[dim]||0) + centered*w;
  }
  state.askedIds.push(q.id);
  state.answered++;
}

function likertLabel(v){
  if (v===1) return "Strongly disagree / Not me";
  if (v===2) return "Somewhat disagree";
  if (v===3) return "Neutral / Depends";
  if (v===4) return "Somewhat agree";
  return "Strongly agree / Very me";
}

function renderQuestion(){
  setBar();
  if (state.answered >= MAX_Q){
    return renderResults();
  }
  const q = pickNextQuestion();
  if (!q) return renderResults();

  setStatus(`Question ${state.answered+1} of ${MAX_Q}`);
  elApp.innerHTML = `
    <div style="font-weight:950;font-size:18px;margin-bottom:6px">${escapeHtml(q.text)}</div>
    <div class="muted">${escapeHtml(q.hint || "Answer fast and honest.")}</div>
    <div style="height:1px;background:rgba(255,255,255,.12);margin:14px 0"></div>
    <div class="row">
      ${[1,2,3,4,5].map(v=>`
        <button class="btn opt" onclick="window.answer('${q.id}', ${v})">${likertLabel(v)}</button>
      `).join("")}
    </div>
    <div style="height:1px;background:rgba(255,255,255,.12);margin:14px 0"></div>
    <div class="muted">Zig reminder: “You don’t have to be great to start, but you have to start to be great.”</div>
  `;
}

window.answer = function(qid, value){
  const q = QUESTIONS.find(x=>x.id===qid);
  if (!q) return;
  applyAnswer(q, value);
  renderQuestion();
}

function dot(profile, scores){
  let s=0;
  for (const [k,v] of Object.entries(profile)){
    s += (scores[k]||0) * v;
  }
  return s;
}

function careerFit(c){
  let s = dot(c.profile, state.scores);

  // light environment bias
  if (c.env){
    s += (c.env.outdoors||0) * clamp(state.scores.outdoors,-6,6) * 0.30;
    s += (c.env.desk||0)     * clamp(state.scores.focusDesk,-6,6) * 0.25;
    s += (c.env.travel||0)   * clamp(state.scores.travel,-6,6) * 0.20;
  }

  // soft education bias
  if (c.education){
    const tol = state.scores.eduTolerance;
    const debt = state.scores.debtAversion;
    const lvl = c.education.level || 0;
    s += tol * lvl * 0.15;
    s -= debt * lvl * 0.15;
  }

  return s;
}

function renderResults(){
  state.finished = true;
  setBar();
  setStatus("Results ready.");

  const scored = CAREERS.map(c => ({...c, score: careerFit(c)})).sort((a,b)=>b.score-a.score);
  const top = scored.slice(0, SHOW_TOP);

  elApp.innerHTML = `
    <div style="font-weight:950;font-size:18px;margin-bottom:6px">Top career matches</div>
    <div class="muted">These are starting points. The win is clarity + wise next steps.</div>

    <div style="height:1px;background:rgba(255,255,255,.12);margin:14px 0"></div>

    <div class="row">
      <div style="flex:1 1 320px"><input id="search" placeholder="Search results (e.g., nurse, engineer, business)"/></div>
      <div style="flex:1 1 220px">
        <select id="fam">
          <option value="">All families</option>
          ${[...new Set(CAREERS.map(x=>x.family))].sort().map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("")}
        </select>
      </div>
    </div>

    <div id="list" style="margin-top:12px"></div>
  `;

  const elList = document.getElementById("list");
  const elSearch = document.getElementById("search");
  const elFam = document.getElementById("fam");

  function draw(){
    const q = (elSearch.value||"").toLowerCase().trim();
    const fam = elFam.value;

    const shown = top.filter(c=>{
      if (fam && c.family !== fam) return false;
      if (!q) return true;
      const hay = (c.title + " " + c.family + " " + (c.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    });

    elList.innerHTML = shown.map(c=>`
      <div class="card" style="padding:14px">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:950">${escapeHtml(c.title)}</div>
            <div class="muted">${escapeHtml(c.family)} • ${escapeHtml(c.education?.label || "Varies")}</div>
            <div class="muted" style="margin-top:6px">${escapeHtml((c.tags||[]).slice(0,6).join(" • "))}</div>
          </div>
          <div class="pill"><b>${c.score.toFixed(1)}</b> fit</div>
        </div>
      </div>
    `).join("") || `<div class="muted">No matches. Try another search.</div>`;
  }

  elSearch.addEventListener("input", draw);
  elFam.addEventListener("change", draw);
  draw();
}

function resetAll(){
  state = { answered:0, askedIds:[], scores:{}, finished:false };
  initScores();
  setStatus(`Loaded ${QUESTIONS?.length||0} questions and ${CAREERS?.length||0} careers.`);
  renderQuestion();
}

loadData();
</script>
</body>
</html>
